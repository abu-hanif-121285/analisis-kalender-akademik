<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Perangkat Ajar & Kalender Pendidikan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (untuk JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .rotate-text {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // Import React hooks dan components dari global object
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- INTERNAL ICONS (Replaces Lucide Dependency) ---
        // Helper to create consistent SVG icons
        const createIcon = (content) => ({ size = 24, className = "", ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {content}
            </svg>
        );

        // Icon Definitions
        const Icons = {
            Calendar: createIcon(<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>),
            Save: createIcon(<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>),
            Calculator: createIcon(<><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></>),
            BookOpen: createIcon(<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></>),
            Grid: createIcon(<><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></>),
            ChevronLeft: createIcon(<polyline points="15 18 9 12 15 6"></polyline>),
            ChevronRight: createIcon(<polyline points="9 18 15 12 9 6"></polyline>),
            CheckCircle: createIcon(<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>),
            AlertCircle: createIcon(<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>),
            Trash2: createIcon(<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>),
            Plus: createIcon(<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>),
            Download: createIcon(<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>),
            Info: createIcon(<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></>),
            X: createIcon(<><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>),
            CheckSquare: createIcon(<><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></>),
            Square: createIcon(<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>),
            FileSpreadsheet: createIcon(<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></>),
            Edit3: createIcon(<><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></>),
            Settings: createIcon(<><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>),
            Menu: createIcon(<><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></>)
        };

        // Destructure icons for easy usage in code
        const { 
            Calendar, Save, Calculator, BookOpen, Grid, ChevronLeft, ChevronRight, 
            CheckCircle, AlertCircle, Trash2, Plus, Download, Info, X, 
            CheckSquare, Square, FileSpreadsheet, Edit3, Settings, Menu
        } = Icons;


        // --- Tipe Data & Konstanta ---

        const MONTHS = [
            { id: 7, name: 'Juli', semester: 1 }, { id: 8, name: 'Agustus', semester: 1 }, { id: 9, name: 'September', semester: 1 },
            { id: 10, name: 'Oktober', semester: 1 }, { id: 11, name: 'November', semester: 1 }, { id: 12, name: 'Desember', semester: 1 },
            { id: 1, name: 'Januari', semester: 2 }, { id: 2, name: 'Februari', semester: 2 }, { id: 3, name: 'Maret', semester: 2 },
            { id: 4, name: 'April', semester: 2 }, { id: 5, name: 'Mei', semester: 2 }, { id: 6, name: 'Juni', semester: 2 }
        ];

        const DAYS = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

        const CLASS_OPTIONS = ['Kelas 1', 'Kelas 2', 'Kelas 3', 'Kelas 4', 'Kelas 5', 'Kelas 6'];

        const SUBJECT_OPTIONS = [
            'Pendidikan Agama Islam (PAI)',
            'Pendidikan Pancasila (PP)',
            'Bahasa Indonesia',
            'Matematika',
            'IPAS',
            'Bahasa Inggris',
            'Bahasa Arab',
            'Bahasa Sunda',
            'Seni Rupa',
            'PJOK'
        ];

        const COLOR_OPTIONS = [
            { label: 'Pink', value: 'bg-pink-100 text-pink-800 border-pink-200' },
            { label: 'Fuchsia', value: 'bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200' },
            { label: 'Violet', value: 'bg-violet-100 text-violet-800 border-violet-200' },
            { label: 'Sky', value: 'bg-sky-100 text-sky-800 border-sky-200' },
            { label: 'Slate', value: 'bg-slate-100 text-slate-800 border-slate-200' },
            { label: 'Orange', value: 'bg-orange-100 text-orange-800 border-orange-200' }, 
            { label: 'Lime', value: 'bg-lime-100 text-lime-800 border-lime-200' },     
        ];

        const INITIAL_EVENT_TYPES = {
            kbm: { label: 'KBM Efektif', color: 'bg-green-50 text-green-800 border-green-200', selectable: true, isEffective: true },
            libur_nasional: { label: 'Libur Nasional', color: 'bg-red-100 text-red-800 border-red-200', selectable: true, isEffective: false },
            libur_semester: { label: 'Libur Semester', color: 'bg-orange-100 text-orange-800 border-orange-200', selectable: true, isEffective: false },
            kegiatan_sekolah: { label: 'Kegiatan Khusus (Efektif)', color: 'bg-blue-100 text-blue-800 border-blue-200', selectable: true, isEffective: true },
            pts: { label: 'PTS / STS', color: 'bg-indigo-100 text-indigo-800 border-indigo-200', selectable: true, isEffective: true }, 
            pas: { label: 'PAS / SAS', color: 'bg-purple-100 text-purple-800 border-purple-200', selectable: true, isEffective: true },
            mpls: { label: 'MPLS', color: 'bg-yellow-100 text-yellow-800 border-yellow-200', selectable: true, isEffective: true },
            lpp: { label: 'LPP (Awal Puasa)', color: 'bg-lime-100 text-lime-800 border-lime-200', selectable: true, isEffective: false },
            lhr: { label: 'LHR (Hari Raya)', color: 'bg-emerald-100 text-emerald-800 border-emerald-200', selectable: true, isEffective: false },
        };

        const INITIAL_HOLIDAYS_2026 = {
            '2026-01-01': { type: 'libur_nasional', label: 'Tahun Baru 2026 Masehi' },
            '2026-01-16': { type: 'libur_nasional', label: 'Isra Mikraj Nabi Muhammad SAW' },
            '2026-02-17': { type: 'libur_nasional', label: 'Tahun Baru Imlek 2577 Kongzili' },
            '2026-03-19': { type: 'libur_nasional', label: 'Hari Suci Nyepi (Tahun Baru Saka 1948)' },
            '2026-03-21': { type: 'libur_nasional', label: 'Idulfitri 1447 Hijriah' },
            '2026-03-22': { type: 'libur_nasional', label: 'Idulfitri 1447 Hijriah' },
            '2026-04-03': { type: 'libur_nasional', label: 'Wafat Yesus Kristus' },
            '2026-04-05': { type: 'libur_nasional', label: 'Kebangkitan Yesus Kristus (Paskah)' },
            '2026-05-01': { type: 'libur_nasional', label: 'Hari Buruh Internasional' },
            '2026-05-14': { type: 'libur_nasional', label: 'Kenaikan Yesus Kristus' },
            '2026-05-27': { type: 'libur_nasional', label: 'Iduladha 1447 Hijriah' },
            '2026-05-31': { type: 'libur_nasional', label: 'Hari Raya Waisak 2570 BE' },
            '2026-06-01': { type: 'libur_nasional', label: 'Hari Lahir Pancasila' },
            '2026-06-16': { type: 'libur_nasional', label: '1 Muharam Tahun Baru Islam 1448 Hijriah' },
            '2026-08-17': { type: 'libur_nasional', label: 'Hari Proklamasi Kemerdekaan RI' },
            '2026-08-25': { type: 'libur_nasional', label: 'Maulid Nabi Muhammad SAW' },
            '2026-12-25': { type: 'libur_nasional', label: 'Kelahiran Yesus Kristus' },
        };

        // --- Komponen Utilitas ---

        const Button = ({ children, onClick, variant = 'primary', className = '', icon: Icon, disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed",
                secondary: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 disabled:opacity-50",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-200",
                ghost: "bg-transparent text-gray-600 hover:bg-gray-100"
            };
            
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {Icon && <Icon size={18} />}
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-200 ${className}`}>
                {children}
            </div>
        );

        // --- Main Application Component ---

        function TeachingApp() {
            const [activeTab, setActiveTab] = useState('calendar');
            const [year, setYear] = useState(2025);
            
            // State Utama
            const [events, setEvents] = useState(INITIAL_HOLIDAYS_2026); 
            const [eventTypes, setEventTypes] = useState(INITIAL_EVENT_TYPES);
            const [selectedEventType, setSelectedEventType] = useState('libur_nasional');
            
            // State: Mode Input
            const [isManualEntry, setIsManualEntry] = useState(false); 
            const [noteModal, setNoteModal] = useState({ isOpen: false, date: null, type: '', note: '' });

            // State untuk PROMES PER TANGGAL
            const [teachingDays, setTeachingDays] = useState([1]); // Default: Senin (1)
            const [activeSemester, setActiveSemester] = useState(1); // 1 = Ganjil, 2 = Genap

            // State untuk Modal Tambah Kegiatan Baru
            const [isAddingType, setIsAddingType] = useState(false);
            const [newTypeData, setNewTypeData] = useState({ label: '', color: COLOR_OPTIONS[0].value, isEffective: false });
            
            // Data Sekolah & Pelajaran
            const [meta, setMeta] = useState({
                schoolName: 'SDIT Insantama',
                subject: 'Matematika', 
                grade: 'Kelas 1',      
                semester: 'Ganjil',
                hoursPerWeek: 4 
            });

            // Data Prota
            const [prota, setProta] = useState([
                { id: 1, kd: '3.1', topic: 'Bilangan Bulat', hours: 40, semester: 1, subject: 'Matematika' },
                { id: 2, kd: '1.1', topic: 'Rukun Islam', hours: 20, semester: 1, subject: 'Pendidikan Agama Islam (PAI)' },
                { id: 3, kd: '3.3', topic: 'Bentuk Aljabar', hours: 30, semester: 2, subject: 'Matematika' }, 
            ]);

            // Data Promes (Menyimpan alokasi jam per sel)
            // Format Key: "protaId-tanggal" -> Value: jam
            const [promes, setPromes] = useState({});

            // Generate Year Options until 2075
            const yearOptions = useMemo(() => {
                const startYear = 2024;
                const endYear = 2075;
                const years = [];
                for(let y = startYear; y <= endYear; y++) {
                    years.push(y);
                }
                return years;
            }, []);

            // --- Logic Download Excel ---
            const handleDownloadExcel = (tableId, fileName) => {
                const table = document.getElementById(tableId);
                if (!table) {
                    alert('Tabel tidak ditemukan');
                    return;
                }

                const html = table.outerHTML;
                const blob = new Blob([`
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                        <head>
                            <!--[if gte mso 9]>
                            <xml>
                                <x:ExcelWorkbook>
                                    <x:ExcelWorksheets>
                                        <x:ExcelWorksheet>
                                            <x:Name>Sheet1</x:Name>
                                            <x:WorksheetOptions>
                                                <x:DisplayGridlines/>
                                            </x:WorksheetOptions>
                                        </x:ExcelWorksheet>
                                    </x:ExcelWorksheets>
                                </x:ExcelWorkbook>
                            </xml>
                            <![endif]-->
                            <meta charset="utf-8">
                            <style>
                                table { border-collapse: collapse; }
                                td, th { border: 1px solid #000; padding: 5px; mso-number-format:"\@"; }
                            </style>
                        </head>
                        <body>
                            ${html}
                        </body>
                    </html>
                `], { type: 'application/vnd.ms-excel' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileName}.xls`;
                a.click();
                URL.revokeObjectURL(url);
            };

            // --- Logic Kaldik & RME ---

            const getDaysInMonth = (monthId, yearVal) => {
                const realYear = monthId >= 7 ? yearVal : yearVal + 1;
                const date = new Date(realYear, monthId - 1, 1);
                const days = [];
                while (date.getMonth() === monthId - 1) {
                    days.push(new Date(date));
                    date.setDate(date.getDate() + 1);
                }
                return days;
            };

            const formatDate = (date) => {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            };

            const handleDateClick = (dateStr) => {
                if (isManualEntry) {
                    const currentEvent = events[dateStr];
                    setNoteModal({
                        isOpen: true,
                        date: dateStr,
                        type: currentEvent ? currentEvent.type : selectedEventType,
                        note: currentEvent ? currentEvent.label : ''
                    });
                } else {
                    toggleDate(dateStr);
                }
            };

            const handleSaveNote = () => {
                const { date, type, note } = noteModal;
                setEvents(prev => ({
                    ...prev,
                    [date]: {
                        type: type,
                        label: note || eventTypes[type]?.label 
                    }
                }));
                setNoteModal({ ...noteModal, isOpen: false });
            };

            const handleDeleteEvent = (dateStr) => {
                setEvents(prev => {
                    const newEvents = { ...prev };
                    delete newEvents[dateStr];
                    return newEvents;
                });
                setNoteModal({ ...noteModal, isOpen: false });
            }

            const toggleDate = (dateStr) => {
                setEvents(prev => {
                    const newEvents = { ...prev };
                    const currentEvent = newEvents[dateStr];
                    const typeLabel = eventTypes[selectedEventType]?.label;

                    if (currentEvent && currentEvent.type === selectedEventType) {
                        delete newEvents[dateStr]; 
                    } else {
                        newEvents[dateStr] = { 
                            type: selectedEventType, 
                            label: typeLabel 
                        }; 
                    }
                    return newEvents;
                });
            };

            const getDayStatus = (dateStr, dayIndex) => {
                if (events[dateStr]) return events[dateStr].type;
                if (dayIndex === 0 || dayIndex === 6) return 'libur_nasional'; // Default libur Sabtu Minggu
                return 'kbm';
            };
            
            const getEventLabel = (dateStr) => {
                if (events[dateStr]) return events[dateStr].label;
                return null;
            };

            const handleAddNewType = () => {
                if (!newTypeData.label) return;
                const id = newTypeData.label.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
                setEventTypes(prev => ({
                    ...prev,
                    [id]: {
                        label: newTypeData.label,
                        color: newTypeData.color,
                        selectable: true,
                        isEffective: newTypeData.isEffective
                    }
                }));
                setSelectedEventType(id); 
                setIsAddingType(false);
                setNewTypeData({ label: '', color: COLOR_OPTIONS[0].value, isEffective: false });
            };

            const handleDeleteType = (key) => {
                const defaultKeys = Object.keys(INITIAL_EVENT_TYPES);
                if(defaultKeys.includes(key)) return;
                setEventTypes(prev => {
                    const newState = { ...prev };
                    delete newState[key];
                    return newState;
                });
                if(selectedEventType === key) setSelectedEventType('kbm');
            };

            // --- ANALISIS HARI EFEKTIF (RHE) ---
            const effectiveDaysAnalysis = useMemo(() => {
                const data = [];
                const semesterSummary = {
                    1: { totalWeeks: 0, totalEffectiveWeeks: 0, dayCounts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 } },
                    2: { totalWeeks: 0, totalEffectiveWeeks: 0, dayCounts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 } }
                };

                MONTHS.forEach(m => {
                    const days = getDaysInMonth(m.id, year);
                    
                    const dayCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }; 
                    let kbmDaysInMonth = 0;
                    const weeks = {};

                    days.forEach(d => {
                        const dayIdx = d.getDay();
                        const dateStr = formatDate(d);
                        const status = getDayStatus(dateStr, dayIdx);
                        const typeDef = eventTypes[status];
                        const isEffective = status === 'kbm' || (typeDef && typeDef.isEffective);

                        if (dayIdx >= 1 && dayIdx <= 5 && isEffective) {
                            dayCounts[dayIdx]++;
                            kbmDaysInMonth++;
                        }

                        const weekIdx = Math.ceil(d.getDate() / 7);
                        if(!weeks[weekIdx]) weeks[weekIdx] = [];
                        weeks[weekIdx].push({ date: d, isEffective });
                    });

                    Object.keys(dayCounts).forEach(dKey => {
                        semesterSummary[m.semester].dayCounts[dKey] += dayCounts[dKey];
                    });

                    let effectiveWeeksInMonth = 0;
                    let totalWeeksInMonth = 0;
                    
                    Object.values(weeks).forEach(weekDays => {
                        totalWeeksInMonth++;
                        const effectiveCount = weekDays.filter(wd => wd.isEffective).length;
                        // Asumsi: Minggu efektif jika minimal 3 hari efektif
                        if (effectiveCount >= 3) effectiveWeeksInMonth++;
                    });

                    semesterSummary[m.semester].totalWeeks += totalWeeksInMonth;
                    semesterSummary[m.semester].totalEffectiveWeeks += effectiveWeeksInMonth;

                    data.push({
                        month: m.name,
                        semester: m.semester,
                        dayCounts,
                        kbmDaysInMonth,
                        effectiveWeeksInMonth
                    });
                });

                return { monthly: data, semesterSummary };
            }, [events, year, eventTypes]);

            // --- Logic Promes Data ---
            const scheduleData = useMemo(() => {
                const startIndex = activeSemester === 1 ? 0 : 6;
                const endIndex = activeSemester === 1 ? 6 : 12;
                const semMonths = MONTHS.slice(startIndex, endIndex);

                return semMonths.map(m => {
                    const days = getDaysInMonth(m.id, year);
                    const validDates = days.filter(d => teachingDays.includes(d.getDay()));
                    return {
                        month: m.name,
                        monthId: m.id,
                        dates: validDates
                    };
                });
            }, [year, teachingDays, activeSemester]);


            const toggleTeachingDay = (dayIndex) => {
                setTeachingDays(prev => {
                    if (prev.includes(dayIndex)) {
                        return prev.filter(d => d !== dayIndex);
                    } else {
                        return [...prev, dayIndex].sort();
                    }
                });
            };

            const promesSemesterProta = useMemo(() => 
                prota.filter(p => p.semester === activeSemester && p.subject === meta.subject),
                [prota, activeSemester, meta.subject]
            );

            const totalDistributedJP = useMemo(() => {
                let total = 0;
                promesSemesterProta.forEach(item => {
                    scheduleData.forEach(m => {
                        m.dates.forEach(date => {
                            const dStr = formatDate(date);
                            const cellKey = `${item.id}-${dStr}`;
                            const val = parseInt(promes[cellKey]) || 0;
                            total += val;
                        });
                    });
                });
                return total;
            }, [promes, promesSemesterProta, scheduleData]);

            // --- Handler Promes Input ---
            const handlePromesChange = (itemId, dateStr, val) => {
                const key = `${itemId}-${dateStr}`;
                const numVal = val === '' ? 0 : parseInt(val);
                setPromes(prev => ({ ...prev, [key]: numVal }));
            };

            // --- Render Functions ---

            const renderCalendar = () => (
                <div className="space-y-6 relative">
                    {/* MODAL INPUT CATATAN */}
                    {noteModal.isOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-lg font-bold text-gray-800">Edit Kegiatan / Catatan</h3>
                                    <button onClick={() => setNoteModal({...noteModal, isOpen: false})} className="text-gray-400 hover:text-gray-600"><X size={20}/></button>
                                </div>
                                
                                <div className="space-y-3">
                                    <div className="bg-gray-50 p-2 rounded text-sm text-center font-semibold text-gray-600">
                                        {noteModal.date}
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Jenis Kegiatan</label>
                                        <select 
                                            value={noteModal.type} 
                                            onChange={e => setNoteModal({...noteModal, type: e.target.value})}
                                            className="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                        >
                                            <option value="kbm">KBM (Hari Efektif)</option>
                                            {Object.entries(eventTypes).map(([key, val]) => (
                                                <option key={key} value={key}>{val.label}</option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Catatan Khusus</label>
                                        <input 
                                            autoFocus
                                            type="text" 
                                            value={noteModal.note}
                                            onChange={e => setNoteModal({...noteModal, note: e.target.value})}
                                            placeholder="Contoh: Tahun Baru 2026"
                                            className="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        />
                                    </div>
                                </div>

                                <div className="flex gap-2 pt-2">
                                    <Button onClick={() => handleDeleteEvent(noteModal.date)} variant="danger" className="flex-1 justify-center" icon={Trash2}>Hapus</Button>
                                    <Button onClick={handleSaveNote} className="flex-1 justify-center">Simpan</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Tambah Jenis Kegiatan */}
                    {isAddingType && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-lg font-bold text-gray-800">Tambah Jenis Kegiatan</h3>
                                    <button onClick={() => setIsAddingType(false)} className="text-gray-400 hover:text-gray-600"><X size={20}/></button>
                                </div>
                                
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Nama Kegiatan</label>
                                        <input 
                                            autoFocus
                                            type="text" 
                                            value={newTypeData.label}
                                            onChange={e => setNewTypeData({...newTypeData, label: e.target.value})}
                                            placeholder="Misal: Renang / Kunjungan"
                                            className="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        />
                                    </div>

                                    <div className="flex items-center gap-2 bg-blue-50 p-3 rounded-lg border border-blue-100">
                                        <input 
                                            type="checkbox"
                                            id="isEffectiveCheck"
                                            checked={newTypeData.isEffective}
                                            onChange={e => setNewTypeData({...newTypeData, isEffective: e.target.checked})}
                                            className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                                        />
                                        <label htmlFor="isEffectiveCheck" className="text-sm text-blue-800">
                                            <strong>Hitung sebagai Hari Efektif?</strong>
                                            <div className="text-xs text-blue-600 font-normal mt-0.5">
                                                Centang jika kegiatan ini tidak meliburkan siswa seharian (misal: Renang pagi, lalu KBM).
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Pilih Warna Penanda</label>
                                        <div className="grid grid-cols-4 gap-2">
                                            {COLOR_OPTIONS.map((c) => (
                                                <button
                                                    key={c.value}
                                                    onClick={() => setNewTypeData({...newTypeData, color: c.value})}
                                                    className={`h-8 rounded-md border-2 transition-all ${c.value.split(' ')[0]} ${newTypeData.color === c.value ? 'border-blue-500 ring-2 ring-blue-200' : 'border-transparent'}`}
                                                    title={c.label}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-2 pt-2">
                                    <Button onClick={() => setIsAddingType(false)} variant="ghost" className="flex-1 justify-center">Batal</Button>
                                    <Button onClick={handleAddNewType} disabled={!newTypeData.label} className="flex-1 justify-center">Simpan</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 space-y-4">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 className="text-xl font-bold text-gray-800">Kalender Pendidikan</h2>
                                <p className="text-sm text-gray-500">Tahun Pelajaran {year}/{year + 1}</p>
                            </div>
                            
                            {/* TOGGLE MODE MANUAL */}
                            <div className="flex items-center gap-3 bg-gray-50 p-2 rounded-lg border">
                                <span className={`text-xs font-semibold ${!isManualEntry ? 'text-blue-600' : 'text-gray-500'}`}>Mode Cepat</span>
                                <button 
                                    onClick={() => setIsManualEntry(!isManualEntry)}
                                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none ${isManualEntry ? 'bg-blue-600' : 'bg-gray-300'}`}
                                >
                                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${isManualEntry ? 'translate-x-6' : 'translate-x-1'}`} />
                                </button>
                                <span className={`text-xs font-semibold ${isManualEntry ? 'text-blue-600' : 'text-gray-500'}`}>Mode Input Catatan</span>
                            </div>
                        </div>
                        
                        {isManualEntry && (
                            <div className="bg-blue-50 p-3 rounded-lg text-sm text-blue-800 border border-blue-100 flex items-center gap-2">
                                <Info size={16}/>
                                <span><strong>Info:</strong> Klik tanggal mana saja untuk membuka popup dan menulis catatan khusus (misal: "Tahun Baru").</span>
                            </div>
                        )}

                        <div className="border-t pt-4">
                            <div className="flex justify-between items-center mb-2">
                                <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide">Pilih Jenis Kegiatan (Untuk Mode Cepat):</p>
                                <button 
                                    onClick={() => setIsAddingType(true)}
                                    className="text-xs flex items-center gap-1 text-blue-600 font-bold hover:text-blue-700 bg-blue-50 px-2 py-1 rounded-md transition-colors"
                                >
                                    <Plus size={14}/> Tambah Jenis Baru
                                </button>
                            </div>
                            
                            <div className={`flex flex-wrap gap-2 ${isManualEntry ? 'opacity-50 pointer-events-none' : ''}`}>
                                {Object.entries(eventTypes).map(([key, val]) => (
                                    val.selectable && (
                                        <div key={key} className="relative group">
                                            <button
                                            onClick={() => setSelectedEventType(key)}
                                            className={`px-3 py-1.5 text-xs font-semibold rounded-md border transition-all flex items-center gap-2 ${
                                                selectedEventType === key 
                                                ? 'ring-2 ring-offset-1 ring-blue-500 shadow-md transform scale-105 ' + val.color 
                                                : 'opacity-70 hover:opacity-100 bg-gray-50 text-gray-700 hover:bg-white hover:shadow-sm'
                                            }`}
                                            >
                                            <span className={`w-2 h-2 rounded-full ${val.color.split(' ')[0].replace('bg-', 'bg-')}`}></span>
                                            {val.label}
                                            {val.isEffective && <span className="ml-1 text-[10px] bg-white/50 px-1 rounded">Efektif</span>}
                                            </button>
                                            
                                            {!Object.keys(INITIAL_EVENT_TYPES).includes(key) && (
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); handleDeleteType(key); }}
                                                    className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"
                                                    title="Hapus"
                                                >
                                                    <X size={10} />
                                                </button>
                                            )}
                                        </div>
                                    )
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {MONTHS.map((month) => {
                            const days = getDaysInMonth(month.id, year);
                            const startDay = days[0].getDay(); 
                            
                            return (
                                <Card key={month.id} className="p-4">
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <h3 className="font-bold text-gray-700">{month.name}</h3>
                                        <span className="text-xs text-gray-400">{month.id >= 7 ? year : year + 1}</span>
                                    </div>
                                    <div className="grid grid-cols-7 gap-1 mb-2">
                                        {DAYS.map(d => (
                                            <div key={d} className="text-center text-[10px] font-bold text-gray-400 uppercase">{d.substr(0, 3)}</div>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-7 gap-1 text-sm">
                                        {Array.from({ length: startDay }).map((_, i) => <div key={`empty-${i}`} />)}
                                        {days.map(date => {
                                            const dateStr = formatDate(date);
                                            const status = getDayStatus(dateStr, date.getDay());
                                            const label = getEventLabel(dateStr);
                                            
                                            const eventType = eventTypes[status];
                                            const colorClass = eventType?.color || 'hover:bg-gray-100 text-gray-700';
                                            const typeLabel = eventType?.label || (date.getDay() === 0 ? 'Libur Minggu' : 'KBM Efektif');

                                            return (
                                                <button
                                                    key={dateStr}
                                                    onClick={() => handleDateClick(dateStr)}
                                                    title={label || typeLabel} 
                                                    className={`h-8 w-8 rounded-md flex items-center justify-center text-xs transition-colors relative group ${colorClass}`}
                                                >
                                                    {date.getDate()}
                                                    {label && status !== 'kbm' && (
                                                        <span className="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                                                    )}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </Card>
                            );
                        })}
                    </div>
                    
                    <div className="bg-gray-50 p-4 rounded-lg text-xs text-gray-500 flex flex-wrap gap-4 border border-gray-100">
                        <div className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full border border-white shadow-sm"></span> <span>Titik merah menandakan ada catatan khusus</span></div>
                        <div className="flex items-center gap-2"><Info size={14}/> <span>Aktifkan "Mode Input Catatan" di atas untuk memberi nama khusus pada tanggal (misal: Tahun Baru).</span></div>
                    </div>
                </div>
            );

            const renderRME = () => (
                <div className="space-y-6">
                    <div className="flex justify-between items-center bg-blue-50 p-6 rounded-xl border border-blue-100">
                        <div>
                            <h2 className="text-lg font-bold text-blue-900 mb-2">Analisis Hari Efektif (RHE)</h2>
                            <p className="text-sm text-blue-700">
                                Rincian jumlah hari efektif belajar per bulan.
                            </p>
                        </div>
                        <Button variant="secondary" onClick={() => handleDownloadExcel('table-rhe', 'RHE_2025')} icon={Download}>
                            Unduh Excel
                        </Button>
                    </div>

                    <div className="overflow-x-auto">
                        <Card className="overflow-hidden">
                            <table id="table-rhe" className="w-full text-sm text-left">
                                <thead className="bg-gray-50 text-gray-600 font-semibold border-b">
                                    <tr>
                                        <th className="px-4 py-3">Bulan</th>
                                        <th className="px-2 py-3 text-center bg-gray-50">Senin</th>
                                        <th className="px-2 py-3 text-center bg-gray-50">Selasa</th>
                                        <th className="px-2 py-3 text-center bg-gray-50">Rabu</th>
                                        <th className="px-2 py-3 text-center bg-gray-50">Kamis</th>
                                        <th className="px-2 py-3 text-center bg-gray-50">Jumat</th>
                                        <th className="px-4 py-3 text-center font-bold text-green-700">Minggu Efektif</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {effectiveDaysAnalysis.monthly.map((row, idx) => (
                                        <React.Fragment key={idx}>
                                            {/* Divider Semester */}
                                            {idx === 6 && (
                                                <tr className="bg-blue-100 font-bold text-blue-800 text-xs">
                                                    <td colSpan={7} className="py-1 px-4 text-center tracking-wider">SEMESTER 2 (GENAP)</td>
                                                </tr>
                                            )}
                                            <tr className="hover:bg-gray-50">
                                                <td className="px-4 py-3 font-medium text-gray-700">{row.month}</td>
                                                <td className="px-2 py-3 text-center">{row.dayCounts[1]}</td>
                                                <td className="px-2 py-3 text-center">{row.dayCounts[2]}</td>
                                                <td className="px-2 py-3 text-center">{row.dayCounts[3]}</td>
                                                <td className="px-2 py-3 text-center">{row.dayCounts[4]}</td>
                                                <td className="px-2 py-3 text-center">{row.dayCounts[5]}</td>
                                                <td className="px-4 py-3 text-center font-bold text-green-700 bg-green-50/50">{row.effectiveWeeksInMonth}</td>
                                            </tr>
                                        </React.Fragment>
                                    ))}
                                </tbody>
                                <tfoot className="bg-gray-50 font-bold border-t text-xs">
                                    {/* Footer Summary SMT 1 */}
                                    <tr className="border-t-2 border-gray-200 bg-blue-50/30">
                                        <td className="px-4 py-3">TOTAL SMT 1</td>
                                        <td className="px-2 py-3 text-center">{effectiveDaysAnalysis.semesterSummary[1].dayCounts[1]}</td>
                                        <td className="px-2 py-3 text-center">{effectiveDaysAnalysis.semesterSummary[1].dayCounts[2]}</td>
                                        <td className="px-2 py-3 text-center">{effectiveDaysAnalysis.semesterSummary[1].dayCounts[3]}</td>
                                        <td className="px-2 py-3 text-center">{effectiveDaysAnalysis.semesterSummary[1].dayCounts[4]}</td>
                                        <td className="px-2 py-3 text-center">{effectiveDaysAnalysis.semesterSummary[1].dayCounts[5]}</td>
                                        <td className="px-4 py-3 text-center text-blue-700 text-sm">{effectiveDaysAnalysis.semesterSummary[1].totalEffectiveWeeks} Minggu</td>
                                    </tr>
                                    {/* Footer Summary SMT 2 */}
                                    <tr className="bg-blue-50/30">
                                        <td className="px-4 py-3">TOTAL SMT 2</td>
                                        <td className="px-2 py-3 text-center">{effectiveDaysAnalysis.semesterSummary[2].dayCounts[1]}</td>
                                        <td className="px-2 py-3 text-center">{effectiveDaysAnalysis.semesterSummary[2].dayCounts[2]}</td>
                                        <td className="px-2 py-3 text-center">{effectiveDaysAnalysis.semesterSummary[2].dayCounts[3]}</td>
                                        <td className="px-2 py-3 text-center">{effectiveDaysAnalysis.semesterSummary[2].dayCounts[4]}</td>
                                        <td className="px-2 py-3 text-center">{effectiveDaysAnalysis.semesterSummary[2].dayCounts[5]}</td>
                                        <td className="px-4 py-3 text-center text-blue-700 text-sm">{effectiveDaysAnalysis.semesterSummary[2].totalEffectiveWeeks} Minggu</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </Card>
                    </div>
                </div>
            );

            const renderProta = () => (
                <div className="space-y-6">
                    <div className="flex justify-between items-center bg-purple-50 p-6 rounded-xl border border-purple-100">
                        <div>
                            <h2 className="text-lg font-bold text-purple-900 mb-2">Program Tahunan (PROTA)</h2>
                            <p className="text-sm text-purple-700">Daftar Kompetensi Dasar / Materi Pokok dan Alokasi Waktu.</p>
                        </div>
                        <Button onClick={() => setProta([...prota, { id: Date.now(), kd: '', topic: '', hours: 0, semester: activeSemester, subject: meta.subject }])} icon={Plus}>
                            Tambah KD
                        </Button>
                    </div>

                    <Card className="overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-700 border-b">
                                <tr>
                                    <th className="px-4 py-3 w-20">SMT</th>
                                    <th className="px-4 py-3 w-20">No. KD</th>
                                    <th className="px-4 py-3">Materi Pokok / Kompetensi Dasar</th>
                                    <th className="px-4 py-3 w-24 text-center">Alokasi JP</th>
                                    <th className="px-4 py-3 w-20 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {prota.filter(p => p.subject === meta.subject).map((item, index) => (
                                    <tr key={item.id} className="hover:bg-gray-50">
                                        <td className="px-4 py-2">
                                            <select 
                                                value={item.semester} 
                                                onChange={(e) => {
                                                    const updated = [...prota];
                                                    updated.find(p => p.id === item.id).semester = parseInt(e.target.value);
                                                    setProta(updated);
                                                }}
                                                className="bg-transparent border-none focus:ring-0 text-center w-full"
                                            >
                                                <option value={1}>1</option>
                                                <option value={2}>2</option>
                                            </select>
                                        </td>
                                        <td className="px-4 py-2">
                                            <input 
                                                type="text" 
                                                value={item.kd} 
                                                onChange={(e) => {
                                                    const updated = [...prota];
                                                    updated.find(p => p.id === item.id).kd = e.target.value;
                                                    setProta(updated);
                                                }}
                                                className="w-full border rounded px-2 py-1"
                                                placeholder="3.1"
                                            />
                                        </td>
                                        <td className="px-4 py-2">
                                            <input 
                                                type="text" 
                                                value={item.topic} 
                                                onChange={(e) => {
                                                    const updated = [...prota];
                                                    updated.find(p => p.id === item.id).topic = e.target.value;
                                                    setProta(updated);
                                                }}
                                                className="w-full border rounded px-2 py-1"
                                                placeholder="Topik Pembelajaran"
                                            />
                                        </td>
                                        <td className="px-4 py-2">
                                            <input 
                                                type="number" 
                                                value={item.hours} 
                                                onChange={(e) => {
                                                    const updated = [...prota];
                                                    updated.find(p => p.id === item.id).hours = parseInt(e.target.value) || 0;
                                                    setProta(updated);
                                                }}
                                                className="w-full border rounded px-2 py-1 text-center"
                                            />
                                        </td>
                                        <td className="px-4 py-2 text-center">
                                            <button 
                                                onClick={() => setProta(prota.filter(p => p.id !== item.id))}
                                                className="text-red-500 hover:text-red-700"
                                            >
                                                <Trash2 size={16} />
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                                {prota.length === 0 && (
                                    <tr>
                                        <td colSpan={5} className="px-4 py-8 text-center text-gray-400">Belum ada data PROTA. Klik tombol tambah.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </Card>
                </div>
            );

            const renderPromes = () => (
                <div className="space-y-6">
                    <div className="flex flex-col md:flex-row justify-between md:items-center bg-orange-50 p-6 rounded-xl border border-orange-100 gap-4">
                        <div>
                            <h2 className="text-lg font-bold text-orange-900 mb-1">Program Semester (PROMES)</h2>
                            <p className="text-sm text-orange-700">Distribusi Alokasi Waktu per Minggu Efektif.</p>
                        </div>
                        <div className="flex items-center gap-4 bg-white p-2 rounded-lg shadow-sm">
                            <span className="text-xs font-bold text-gray-500 uppercase">Jadwal Mapel:</span>
                            <div className="flex gap-2">
                                {['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'].map((d, i) => {
                                    const dayIdx = i + 1;
                                    const isActive = teachingDays.includes(dayIdx);
                                    return (
                                        <button 
                                            key={d}
                                            onClick={() => toggleTeachingDay(dayIdx)}
                                            className={`w-8 h-8 rounded-full text-xs font-bold transition-all ${isActive ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}`}
                                        >
                                            {d}
                                        </button>
                                    )
                                })}
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                        <Button 
                            variant={activeSemester === 1 ? 'primary' : 'secondary'} 
                            onClick={() => setActiveSemester(1)}
                            className="text-sm"
                        >
                            Semester 1 (Ganjil)
                        </Button>
                        <Button 
                            variant={activeSemester === 2 ? 'primary' : 'secondary'} 
                            onClick={() => setActiveSemester(2)}
                            className="text-sm"
                        >
                            Semester 2 (Genap)
                        </Button>
                        <div className="ml-auto">
                            <Button variant="secondary" onClick={() => handleDownloadExcel('table-promes', 'PROMES_2025')} icon={Download}>
                                Excel
                            </Button>
                        </div>
                    </div>

                    <div className="overflow-x-auto bg-white rounded-lg shadow border border-gray-200">
                        <table id="table-promes" className="w-full text-xs border-collapse">
                            <thead>
                                <tr className="bg-gray-100 text-gray-700">
                                    <th rowSpan={2} className="p-2 border w-10">KD</th>
                                    <th rowSpan={2} className="p-2 border w-48 text-left">Materi Pokok</th>
                                    <th rowSpan={2} className="p-2 border w-12">Total JP</th>
                                    {scheduleData.map(m => (
                                        <th key={m.monthId} colSpan={m.dates.length} className="p-2 border text-center font-bold bg-gray-50">
                                            {m.month}
                                        </th>
                                    ))}
                                </tr>
                                <tr className="bg-gray-50 text-gray-500">
                                    {scheduleData.map(m => (
                                        m.dates.map(d => (
                                            <th key={d.toISOString()} className="border w-8 h-24 relative p-0 align-bottom hover:bg-gray-100">
                                                <div className="rotate-text absolute bottom-2 left-1/2 -translate-x-1/2 text-[10px]">
                                                    {d.getDate()} - {DAYS[d.getDay()].substring(0,3)}
                                                </div>
                                            </th>
                                        ))
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {promesSemesterProta.map(item => (
                                    <tr key={item.id} className="hover:bg-gray-50">
                                        <td className="p-2 border text-center font-medium">{item.kd}</td>
                                        <td className="p-2 border truncate max-w-xs" title={item.topic}>{item.topic}</td>
                                        <td className="p-2 border text-center font-bold bg-blue-50">{item.hours}</td>
                                        {scheduleData.map(m => (
                                            m.dates.map(d => {
                                                const dStr = formatDate(d);
                                                const status = getDayStatus(dStr, d.getDay());
                                                const isEffective = status === 'kbm' || eventTypes[status]?.isEffective;
                                                const cellKey = `${item.id}-${dStr}`;
                                                const val = promes[cellKey] || '';
                                                
                                                let cellClass = "border p-0 text-center h-8 ";
                                                if (!isEffective) cellClass += ` ${eventTypes[status]?.color || 'bg-red-100'} opacity-50 cursor-not-allowed`;

                                                return (
                                                    <td key={dStr} className={cellClass} title={isEffective ? dStr : `Libur: ${eventTypes[status]?.label}`}>
                                                        {isEffective && (
                                                            <input 
                                                                type="text" 
                                                                value={val}
                                                                onChange={(e) => handlePromesChange(item.id, dStr, e.target.value)}
                                                                className="w-full h-full text-center bg-transparent focus:bg-blue-100 outline-none text-blue-800 font-bold"
                                                            />
                                                        )}
                                                    </td>
                                                );
                                            })
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            // --- Main Layout ---

            return (
                <div className="flex flex-col min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white border-b sticky top-0 z-30 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 text-white p-2 rounded-lg">
                                    <Calendar size={24} />
                                </div>
                                <div>
                                    <h1 className="font-bold text-gray-800 text-lg leading-tight">Perangkat Ajar Digital</h1>
                                    <p className="text-xs text-gray-500">{meta.schoolName} - {year}/{year+1}</p>
                                </div>
                            </div>
                            
                            <div className="hidden md:flex items-center gap-4">
                                <select 
                                    value={meta.subject} 
                                    onChange={e => setMeta({...meta, subject: e.target.value})}
                                    className="bg-gray-100 border-none rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700"
                                >
                                    {SUBJECT_OPTIONS.map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                                <select 
                                    value={year} 
                                    onChange={e => setYear(parseInt(e.target.value))}
                                    className="bg-gray-100 border-none rounded-lg px-3 py-1.5 text-sm font-medium text-gray-700"
                                >
                                    {yearOptions.map(y => <option key={y} value={y}>{y}/{y+1}</option>)}
                                </select>
                            </div>
                        </div>
                    </header>

                    <div className="flex flex-1 max-w-7xl mx-auto w-full">
                        {/* Sidebar Navigation */}
                        <aside className="w-20 md:w-64 bg-white border-r hidden md:block pt-6">
                            <nav className="space-y-1 px-2">
                                <button 
                                    onClick={() => setActiveTab('calendar')}
                                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${activeTab === 'calendar' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-50'}`}
                                >
                                    <Calendar size={20}/>
                                    <span className="hidden md:inline">Kalender Pendidikan</span>
                                </button>
                                <button 
                                    onClick={() => setActiveTab('rhe')}
                                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${activeTab === 'rhe' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-50'}`}
                                >
                                    <Calculator size={20}/>
                                    <span className="hidden md:inline">Analisis RHE</span>
                                </button>
                                <button 
                                    onClick={() => setActiveTab('prota')}
                                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${activeTab === 'prota' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-50'}`}
                                >
                                    <BookOpen size={20}/>
                                    <span className="hidden md:inline">Program Tahunan</span>
                                </button>
                                <button 
                                    onClick={() => setActiveTab('promes')}
                                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${activeTab === 'promes' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-50'}`}
                                >
                                    <Grid size={20}/>
                                    <span className="hidden md:inline">Program Semester</span>
                                </button>
                            </nav>
                        </aside>

                        {/* Mobile Nav */}
                        <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 z-40">
                             <button onClick={() => setActiveTab('calendar')} className={`p-2 rounded-lg ${activeTab === 'calendar' ? 'text-blue-600 bg-blue-50' : 'text-gray-500'}`}><Calendar size={24}/></button>
                             <button onClick={() => setActiveTab('rhe')} className={`p-2 rounded-lg ${activeTab === 'rhe' ? 'text-blue-600 bg-blue-50' : 'text-gray-500'}`}><Calculator size={24}/></button>
                             <button onClick={() => setActiveTab('prota')} className={`p-2 rounded-lg ${activeTab === 'prota' ? 'text-blue-600 bg-blue-50' : 'text-gray-500'}`}><BookOpen size={24}/></button>
                             <button onClick={() => setActiveTab('promes')} className={`p-2 rounded-lg ${activeTab === 'promes' ? 'text-blue-600 bg-blue-50' : 'text-gray-500'}`}><Grid size={24}/></button>
                        </div>

                        {/* Content Area */}
                        <main className="flex-1 p-4 md:p-8 overflow-y-auto pb-24 md:pb-8">
                            {activeTab === 'calendar' && renderCalendar()}
                            {activeTab === 'rhe' && renderRME()}
                            {activeTab === 'prota' && renderProta()}
                            {activeTab === 'promes' && renderPromes()}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TeachingApp />);
    </script>
</body>
</html>